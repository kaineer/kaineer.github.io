<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Тег: capistrano | Caramel sepulcrum]]></title>
  <link href="http://kaineer.info/blog/categories/capistrano/atom.xml" rel="self"/>
  <link href="http://kaineer.info/"/>
  <updated>2015-12-23T14:43:20+05:00</updated>
  <id>http://kaineer.info/</id>
  <author>
    <name><![CDATA[Tangerine Cat]]></name>
    <email><![CDATA[kaineer@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Папа, настрой nginx]]></title>
    <link href="http://kaineer.info/blog/2011/09/08/makeanginx/"/>
    <updated>2011-09-08T10:36:00+06:00</updated>
    <id>http://kaineer.info/blog/2011/09/08/makeanginx</id>
    <content type="html"><![CDATA[<p>Есть задача, даже две. Первая - разобраться с настройкой nginx для отдачи rails-статики
и балансировки двух (трёх, сколько нужно), mongrel-ов. Вторая - всё то же самое, но без mongrel,
а с использованием passenger и, главное, через capistrano.</p>

<!-- more -->


<h2>Nginx + mongrels</h2>

<p>Первую задачу я реализовывал локально, на своей уютненькой убунте и всё решилось сравнительно
мирно.</p>

<p>Убрал из дефолтной конфигурации все директивы server и upstream,
оставил только директивы include - так гибче, если что.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h1>#&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;h1>Virtual Host Configs&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;h1>#&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;p>include /etc/nginx/conf.d/&lt;em>.conf;
</span><span class='line'>include /etc/nginx/sites-enabled/&lt;/em>;</span></code></pre></td></tr></table></div></figure></p>

<p>Добавил в отдельный файл конфигурацию апстрима на двух монгрелах (важен был сам принцип, а не количество)
и сервер:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>upstream mongrel { # &lt;&ndash; имя upstream-а для ссылок на него
</span><span class='line'>  server localhost:3000; # Первый mongrel
</span><span class='line'>  server localhost:3001; # Второй mongrel
</span><span class='line'>  # &lt;&ndash; добавить mongrel-ы по вкусу
</span><span class='line'>}&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>server {
</span><span class='line'>  listen           8084; # &lt;-- номер порта
</span><span class='line'>  server_name      ~^(?&lt;subdomain>[-\w]+).lvh.me$; # &lt;&ndash; Запоминаем subdomain
</span><span class='line'>  access_log       off;&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>  location / {
</span><span class='line'>    proxy_pass       &lt;a href="http://mongrel;">http://mongrel;&lt;/a>
</span><span class='line'>    proxy_set_header Host $subdomain.lvh.me:8084; # &lt;&ndash; Передаём subdomain и port
</span><span class='line'>  }&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>  location ~ ^/(image|stylesheet|javascript)s {
</span><span class='line'>    root             /home/user_name/devel/rails/project_name/public;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></p>

<p>Отдельный пункт в первой задаче был - сохранить для использования в рельсовских контроллерах
субдомен, пришедший в запросе. Что и было реализовано при помощи server_name с регулярным выражением
и proxy_set_header с использованием пришедшего из регэкспа поля $subdomain. Без передачи параметра
Host в запросе к приложению приходил параметр &ldquo;mongrel&rdquo; с никаким субдоменом, а без передачи порта
возникали проблемы с открытием следующих страниц (редиректы, ссылки и т.п.)</p>

<p>Теперь заходим на organization_name.lvh.me:8084 и в приложение приходят запросы с указанным субдоменом
и разбрасываются между монгрелами. Как-то так.</p>

<h2>Capistrano, а потом passenger</h2>

<p>На самом деле, мне просто хотелось лёгкого деплоя. И поэтому я решил что на другую машину я буду
деплоить при помощи capistrano. А passenger всплыл уже потом.</p>

<p>Начинаем, как водится, с нуля:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /home/user_name/devel/rails/project_name
</span><span class='line'>$ capify .
</span><span class='line'>$ emacs -nw config/deploy.rb # &lt;&ndash; Вместо emacs используйте Ваш любимый редактор ;)</span></code></pre></td></tr></table></div></figure></p>

<p>Полученный Capfile оставляем в покое, а вот с config/deploy.rb пришлось потанцевать,
по целому ряду причин. Во-первых, мне категорически не хотелось использовать sudo
при деплое, во-вторых, мне не хотелось вводить пароли при каждом деплое, в третьих,
на удалённой машинке rvm был установлен из-под root-а.</p>

<p>Итак, берём deploy.rb и внимательно на него смотрим.</p>

<p><figure class='code'><figcaption><span>config/deploy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h3&gt;Где всё будет происходить&lt;/</span><span class="n">h3</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="c1">#</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:web</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="mi">195</span><span class="o">.</span><span class="mi">151</span><span class="o">.</span><span class="mi">207</span><span class="o">.</span><span class="mi">37</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c1"># Машинка, куда всё будет деплоиться</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="mi">195</span><span class="o">.</span><span class="mi">151</span><span class="o">.</span><span class="mi">207</span><span class="o">.</span><span class="mi">37</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c1"># Как правило, то же самое, что :web</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:db</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="mi">195</span><span class="o">.</span><span class="mi">151</span><span class="o">.</span><span class="mi">207</span><span class="o">.</span><span class="mi">37</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;,</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="c1"># А здесь будет лежать база данных&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="err">Что</span> <span class="err">ставим</span><span class="p">,</span> <span class="err">куда</span> <span class="err">ставим</span><span class="o">&lt;</span><span class="sr">/h3&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;1. Имя приложения&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span>     <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">your_application_name</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;2. Куда ставим&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span>       <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user_name</span><span class="o">/</span><span class="n">deploy_path</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;3. Откуда берём исходники&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">В</span> <span class="err">нашем</span> <span class="err">случае</span> <span class="err">исходники</span> <span class="err">лежали</span> <span class="err">на</span> <span class="n">bitbucket</span><span class="p">,</span> <span class="err">но</span> <span class="err">никто</span> <span class="err">не</span> <span class="err">запрещает</span> <span class="err">держать</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;их на github или другом хостинге для исходников.&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="c1">#</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span>      <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="ss">ssh</span><span class="p">:</span><span class="sr">//</span><span class="n">hg</span><span class="vi">@bitbucket</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">account_name</span><span class="o">/</span><span class="n">repository_name</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span>             <span class="ss">:mercurial</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;4. Кем ставим&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">Собой</span><span class="p">,</span> <span class="err">любимым</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;set :user,        &amp;ldquo;user_name&amp;rdquo;</span>
</span><span class='line'><span class="sr">set :use_sudo,    false&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="mi">5</span><span class="o">.</span> <span class="err">Форвардим</span> <span class="n">ssh</span><span class="o">-</span><span class="n">agent</span><span class="p">,</span> <span class="err">чтобы</span> <span class="err">удалённая</span> <span class="err">машина</span> <span class="err">знала</span><span class="p">,</span> <span class="err">что</span> <span class="err">это</span> <span class="err">мы</span><span class="o">.</span><span class="n">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;Разумеется, на удалённой машине должен лежать Ваш public key,&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">и</span> <span class="err">на</span> <span class="n">bitbucket</span> <span class="o">-</span> <span class="err">тоже</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;set :ssh_options, {:forward_agent =&gt; true}&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h3</span><span class="o">&gt;</span><span class="no">Bundler</span><span class="o">&lt;</span><span class="sr">/h3&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;1. bundle install автоматически&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="nb">require</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">bundler</span><span class="o">/</span><span class="n">capistrano</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;2. bundle install в домашний каталог (чтобы не запускать рутом)&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="n">set</span> <span class="ss">:bundle_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="o">&amp;</span><span class="n">ndash</span><span class="p">;</span><span class="n">deployment</span> <span class="o">&amp;</span><span class="n">ndash</span><span class="p">;</span><span class="n">quiet</span> <span class="o">&amp;</span><span class="n">ndash</span><span class="p">;</span><span class="n">path</span><span class="o">=</span><span class="sr">/home/use</span><span class="n">r_name</span><span class="o">/</span><span class="n">bundle</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;3. bundle install, но с локальными настройками из $shared_path&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="n">before</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="ss">bundle</span><span class="p">:</span><span class="n">install</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;,</span>     <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="ss">bundler</span><span class="p">:</span><span class="n">config_symlink</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="n">after</span>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="ss">deploy</span><span class="p">:</span><span class="n">setup</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;,</span>       <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="ss">bundler</span><span class="p">:</span><span class="n">config_setup</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;namespace :bundler do</span>
</span><span class='line'><span class="sr">  # Создаём каталог, куда будут сохраняться локальные настройки bundler-а</span>
</span><span class='line'><span class="sr">  #</span>
</span><span class='line'><span class="sr">  task :config_setup do</span>
</span><span class='line'><span class="sr">    run &amp;ldquo;mkdir -p </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="sr">/</span><span class="n">bundler_config</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'>  <span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  # Создаём линк на каталог, чтобы bundler не создавал ./</span><span class="o">.</span><span class="n">bundler</span> <span class="err">по</span><span class="o">-</span><span class="err">новой</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:config_symlink</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">cd</span> <span class="c1">#{release_path} &amp;amp;&amp;amp; ln -s #{shared_path}/bundler_config .bundle&amp;rdquo;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h3&gt;Копируем данные, лежащие в shared/</span><span class="n">config</span> <span class="err">в</span> <span class="err">свой</span> <span class="n">config</span><span class="o">&lt;</span><span class="sr">/h3&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;config/</span><span class="n">database</span><span class="o">.</span><span class="n">yml</span><span class="p">,</span> <span class="err">например</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;#&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">Не</span> <span class="err">забудьте</span> <span class="err">предварительно</span> <span class="err">создать</span> <span class="err">сам</span> <span class="err">каталог</span> <span class="err">и</span> <span class="err">всё</span><span class="p">,</span> <span class="err">что</span> <span class="err">в</span> <span class="err">нём</span> <span class="err">должно</span> <span class="err">лежать</span><span class="o">!&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;#</span>
</span><span class='line'><span class="sr">after  &amp;ldquo;deploy:update_code&amp;rdquo;, &amp;ldquo;deploy:copy_config&amp;rdquo;&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1">### А этот код достаточно просто раскомментировать</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:start</span> <span class="k">do</span> <span class="p">;</span> <span class="k">end</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:stop</span> <span class="k">do</span> <span class="p">;</span> <span class="k">end</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:restart</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">touch</span> <span class="c1">#{File.join(current_path,&amp;lsquo;tmp&amp;rsquo;,&amp;lsquo;restart.txt&amp;rsquo;)}&amp;rdquo;</span>
</span><span class='line'>  <span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  task :copy_config do</span>
</span><span class='line'><span class="sr">    run &amp;ldquo;cp </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="sr">/</span><span class="n">config</span><span class="o">/*</span> <span class="c1">#{release_path}/config/&amp;rdquo;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Примерно так стал выглядеть deploy.rb на моей машинке (если комментарии не считать).
В процессе мне пришлось разбираться, как настроить ssh-forwarding, как запускать
на удалённой машине ssh-agent и как запускать passenger в standalone режиме
и что man-ы и официальная документация are the developer&rsquo;s best friends.</p>

<p>И всё было почти хорошо. И деплой проходил, не заканчиваясь сообщением, что какая-то команда
не прошла, но вот рестарт passenger-а не происходил. Вот если бы passenger-а можно было бы
запускать с командной строки, указывая, в каком каталоге будет производиться запуск, тогда бы,
возможно, следующую часть можно было бы и опустить. А так мне пришлось устанавливать passenger
в конкретном gemset-е, в нём же запускать установку nginx-модуля для passenger и настраивать
nginx уже на работу с /home/user_name/deploy_path/public.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo rvm 1.9.2@project gem install passenger
</span><span class='line'>$ sudo rvm 1.9.2@project passenger-install-nginx-module
</span><span class='line'>$ sudo rvm 1.9.2@project passenger-config &ndash;root # &lt;&ndash; Отсюда возьмём путь к passenger-у
</span><span class='line'>$ sudo vi /opt/nginx/conf/nginx.conf             # &lt;&ndash; Да, иногда я пользуюсь vi. Особенно на удалённых машинах ;)</span></code></pre></td></tr></table></div></figure></p>

<p>Дальше - правки, внесенные в /opt/nginx/conf/nginx.conf</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http {
</span><span class='line'>    # Сюда пишем то, что выдала команда passenger-config &ndash;root
</span><span class='line'>    passenger_root /usr/local/rvm/gems/ruby-1.9.2-p290@crm/gems/passenger-3.0.9;
</span><span class='line'>    # Эту строчку выставляет passenger-install-nginx-module (а откуда ещё я мог её взять?)
</span><span class='line'>    passenger_ruby /usr/local/rvm/wrappers/ruby-1.9.2-p290@crm/ruby;
</span><span class='line'>&hellip;
</span><span class='line'>    # А вот этот кусочек я написал, глядя в руководство
</span><span class='line'>    server {
</span><span class='line'>      listen 80;
</span><span class='line'>      server_name _;
</span><span class='line'>      root /home/user_name/deploy_path/current/public;
</span><span class='line'>      passenger_enabled on;
</span><span class='line'>    }
</span><span class='line'>&hellip;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure></p>

<p>Перезапускаем nginx и идём пить кефир.</p>

<h2>Список используемой литературы</h2>

<ul>
<li><a href="http://unixwiz.net/techtips/ssh-agent-forwarding.html">An Illustrated Guide to SSH Agent Forwarding</a></li>
<li><a href="http://sysoev.ru/nginx/docs/">nginx, документация на сайте автора</a>

<ul>
<li><a href="http://sysoev.ru/nginx/docs/http/ngx_http_core_module.html">Core module</a></li>
<li><a href="http://sysoev.ru/nginx/docs/http/ngx_http_upstream.html">Upstream module</a></li>
</ul>
</li>
<li><a href="http://www.modrails.com/documentation/Users%20guide%20Nginx.html">Phusion Passenger users guide, Nginx version</a></li>
<li><a href="http://daringfireball.net/projects/markdown/syntax">Daring Fireball: Markdown Syntax</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
